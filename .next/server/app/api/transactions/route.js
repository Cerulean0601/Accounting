(()=>{var e={};e.id=717,e.ids=[717],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},5511:e=>{"use strict";e.exports=require("crypto")},4735:e=>{"use strict";e.exports=require("events")},9021:e=>{"use strict";e.exports=require("fs")},1630:e=>{"use strict";e.exports=require("http")},5591:e=>{"use strict";e.exports=require("https")},1645:e=>{"use strict";e.exports=require("net")},1820:e=>{"use strict";e.exports=require("os")},3873:e=>{"use strict";e.exports=require("path")},7910:e=>{"use strict";e.exports=require("stream")},4631:e=>{"use strict";e.exports=require("tls")},9551:e=>{"use strict";e.exports=require("url")},8354:e=>{"use strict";e.exports=require("util")},4075:e=>{"use strict";e.exports=require("zlib")},7598:e=>{"use strict";e.exports=require("node:crypto")},7990:()=>{},8645:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>l,serverHooks:()=>q,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{GET:()=>p,POST:()=>d});var a=r(2706),u=r(8203),n=r(5994),o=r(9187),i=r(2545),c=r(5369);async function p(e){let t=c.j.getUserFromRequest(e);if(!t)return o.NextResponse.json({error:"未授權"},{status:401});let{searchParams:r}=new URL(e.url),s=parseInt(r.get("page")||"1"),a=parseInt(r.get("limit")||"20"),u=r.get("account_id"),n=r.get("category"),p=r.get("type");try{let e=`
      SELECT t.*, a.name as account_name
      FROM transactions t
      JOIN accounts a ON t.account_id = a.account_id
      WHERE t.user_id = $1
    `,r=[t.userId],c=2;u&&(e+=` AND t.account_id = $${c}`,r.push(u),c++),n&&(e+=` AND t.category = $${c}`,r.push(n),c++),p&&(e+=` AND t.type = $${c}`,r.push(p),c++),e+=` ORDER BY t.date DESC, t.created_at DESC LIMIT ${a} OFFSET ${(s-1)*a}`;let d=await i.db.query`${e}`;return o.NextResponse.json(d.rows)}catch(e){return o.NextResponse.json({error:"取得交易失敗"},{status:500})}}async function d(e){let t=c.j.getUserFromRequest(e);if(!t)return o.NextResponse.json({error:"未授權"},{status:401});try{let{account_id:r,amount:s,type:a,category:u,tags:n=[],note:c,date:p}=await e.json();await i.db.query`BEGIN`;let d=await i.db.query`
      INSERT INTO transactions (user_id, account_id, amount, type, category, tags, note, date)
      VALUES (${t.userId}, ${r}, ${s}, ${a}, ${u}, ${n}, ${c}, ${p})
      RETURNING *
    `;return await i.db.query`
      UPDATE accounts 
      SET balance = balance + ${"expense"===a?-s:s}, updated_at = NOW()
      WHERE account_id = ${r}
    `,await i.db.query`COMMIT`,await Promise.all([i.db.cache.del(`accounts:${t.userId}`),i.db.cache.del(`balance:${r}`),i.db.cache.del(`analytics:${t.userId}:${new Date().getMonth()+1}`)]),o.NextResponse.json(d.rows[0])}catch(e){return await i.db.query`ROLLBACK`,o.NextResponse.json({error:"新增交易失敗"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:u.RouteKind.APP_ROUTE,page:"/api/transactions/route",pathname:"/api/transactions",filename:"route",bundlePath:"app/api/transactions/route"},resolvedPagePath:"/mnt/c/Users/xiaoheji/OneDrive - International Games System/文件/GitHub/Accounting/app/api/transactions/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:y,serverHooks:q}=l;function h(){return(0,n.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:y})}},6487:()=>{},8335:()=>{},5369:(e,t,r)=>{"use strict";r.d(t,{j:()=>i});var s=r(3008),a=r.n(s),u=r(8964),n=r.n(u);let o=process.env.JWT_SECRET||"your-secret-key",i={hashPassword:e=>n().hash(e,12),verifyPassword:(e,t)=>n().compare(e,t),generateToken:e=>a().sign({userId:e},o,{expiresIn:"7d"}),verifyToken:e=>{try{return a().verify(e,o)}catch{return null}},getUserFromRequest:e=>{let t=e.headers.get("authorization")?.replace("Bearer ","");return t?i.verifyToken(t):null}}},2545:(e,t,r)=>{"use strict";r.d(t,{db:()=>u});var s=r(6875),a=r(3636);let u={query:s.ll,cache:a.kv}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[989,297],()=>r(8645));module.exports=s})();